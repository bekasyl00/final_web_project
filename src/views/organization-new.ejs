<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PulseBridge | Create Organization</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/styles.css" />
  </head>
  <body>
    <%- include('partials/nav', { currentUser }) %>

    <section class="py-5">
      <div class="container">
        <div class="row g-4 justify-content-center">
          <div class="col-lg-8 fade-up">
            <div class="form-panel">
              <h2 class="section-title">Create Organization</h2>
              <p class="text-muted">Add your organization to host events.</p>
              <% if (error) { %>
                <div class="alert alert-danger"><%= error %></div>
              <% } %>
              <form action="/organizations" method="POST" enctype="multipart/form-data" novalidate>
                <div class="mb-3">
                  <label class="form-label" for="orgName">Name</label>
                  <input id="orgName" name="name" type="text" class="form-control <%= errors.name ? 'is-invalid' : '' %>" value="<%= values.name || '' %>" required minlength="2" />
                  <div class="invalid-feedback"><%= errors.name || 'Введите название организации.' %></div>
                </div>
                <div class="mb-3">
                  <label class="form-label" for="orgDesc">Description</label>
                  <textarea id="orgDesc" name="description" class="form-control <%= errors.description ? 'is-invalid' : '' %>" rows="4"><%= values.description || '' %></textarea>
                  <div class="invalid-feedback"><%= errors.description || 'Введите описание.' %></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Members</label>
                  <div class="member-grid <%= errors.members ? 'is-invalid' : '' %>">
                    <% users.forEach((user) => { %>
                      <% const isSelected = Array.isArray(values.members) ? values.members.includes(user._id.toString()) : values.members === user._id.toString(); %>
                      <% const memberAvatar = user.avatar && user.avatar.startsWith('http') ? user.avatar : `/uploads/${user.avatar || 'default.png'}`; %>
                      <label class="member-card">
                        <input type="checkbox" name="members" value="<%= user._id %>" <%= isSelected ? 'checked' : '' %> />
                        <img class="avatar-mini" src="<%= memberAvatar %>" alt="<%= user.username %>" />
                        <span><%= user.username %></span>
                      </label>
                    <% }) %>
                  </div>
                  <div class="form-text">Можно выбрать несколько пользователей.</div>
                  <% if (errors.members) { %>
                    <div class="text-danger small mt-1"><%= errors.members %></div>
                  <% } %>
                </div>
                <div class="mb-3">
                  <label class="form-label" for="orgImage">Organization Image</label>
                  <input id="orgImage" name="image" type="file" accept="image/*" class="form-control <%= errors.imageUrl ? 'is-invalid' : '' %>" />
                  <div class="invalid-feedback"><%= errors.imageUrl || 'Загрузите изображение.' %></div>
                  <div class="form-text">Если не загрузить, будет использовано default.png.</div>
                </div>
                <button type="submit" class="btn btn-coral w-100">Create Organization</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="container text-center">
        Organizations help group events and volunteers.
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
