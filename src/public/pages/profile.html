<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PulseBridge | Profile</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/styles.css" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg sticky-top border-bottom">
      <div class="container">
        <a class="navbar-brand brand-mark" href="/">
          <span class="brand-dot"></span>
          PulseBridge
        </a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/events">Events</a></li>
            <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="/login">Logout</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <section class="py-5">
      <div class="container">
        <div class="row g-4">
          <div class="col-lg-5 fade-up">
            <div class="form-panel">
              <h2 class="section-title">Profile</h2>
              <p class="text-muted">Your account details from the API.</p>
              <div id="profileAlert" class="alert d-none" role="alert"></div>
              <ul class="list-unstyled mb-0" id="profileDetails">
                <li><strong>Username:</strong> <span id="profileUsername">-</span></li>
                <li><strong>Email:</strong> <span id="profileEmail">-</span></li>
                <li><strong>Role:</strong> <span id="profileRole">-</span></li>
              </ul>
            </div>
          </div>
          <div class="col-lg-7 fade-up fade-delay-1">
            <div class="form-panel">
              <h2 class="section-title">Update Profile</h2>
              <p class="text-muted">Edit your username or email.</p>
              <form id="profileForm" novalidate>
                <div class="mb-3">
                  <label class="form-label" for="profileUsernameInput">Username</label>
                  <input id="profileUsernameInput" type="text" class="form-control" minlength="2" />
                  <div class="invalid-feedback">Имя минимум 2 символа.</div>
                </div>
                <div class="mb-3">
                  <label class="form-label" for="profileEmailInput">Email</label>
                  <input id="profileEmailInput" type="email" class="form-control" />
                  <div class="invalid-feedback">Введите корректный email.</div>
                </div>
                <button type="submit" class="btn btn-coral w-100">Save Changes</button>
                <div id="profileFormAlert" class="alert mt-3 d-none" role="alert"></div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="container text-center">
        Profile data is loaded from /api/users/profile.
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const token = localStorage.getItem('pulsebridge_token');
      const profileAlert = document.getElementById('profileAlert');
      const profileForm = document.getElementById('profileForm');
      const profileFormAlert = document.getElementById('profileFormAlert');

      const showAlert = (el, message, type = 'danger') => {
        el.textContent = message;
        el.className = `alert alert-${type}`;
        el.classList.remove('d-none');
      };

      const loadProfile = async () => {
        if (!token) {
          showAlert(profileAlert, 'Сначала войдите в систему.', 'warning');
          return;
        }

        try {
          const response = await fetch('/api/users/profile', {
            headers: { Authorization: `Bearer ${token}` }
          });

          const payload = await response.json();
          if (!response.ok) {
            showAlert(profileAlert, payload.message || 'Не удалось загрузить профиль.');
            return;
          }

          document.getElementById('profileUsername').textContent = payload.data.username;
          document.getElementById('profileEmail').textContent = payload.data.email;
          document.getElementById('profileRole').textContent = payload.data.role;

          document.getElementById('profileUsernameInput').value = payload.data.username;
          document.getElementById('profileEmailInput').value = payload.data.email;
        } catch (error) {
          showAlert(profileAlert, 'Network error. Try again.');
        }
      };

      profileForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        profileFormAlert.classList.add('d-none');

        if (!profileForm.checkValidity()) {
          profileForm.classList.add('was-validated');
          showAlert(profileFormAlert, 'Проверьте поля формы.', 'warning');
          return;
        }
        profileForm.classList.add('was-validated');

        const username = document.getElementById('profileUsernameInput').value.trim();
        const email = document.getElementById('profileEmailInput').value.trim();
        const updates = {};
        if (username) updates.username = username;
        if (email) updates.email = email;

        try {
          const response = await fetch('/api/users/profile', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify(updates)
          });

          const payload = await response.json();
          if (!response.ok) {
            showAlert(profileFormAlert, payload.message || 'Update failed.');
            return;
          }

          showAlert(profileFormAlert, 'Profile updated successfully.', 'success');
          document.getElementById('profileUsername').textContent = payload.data.username;
          document.getElementById('profileEmail').textContent = payload.data.email;
        } catch (error) {
          showAlert(profileFormAlert, 'Network error. Try again.');
        }
      });

      loadProfile();
    </script>
  </body>
</html>
